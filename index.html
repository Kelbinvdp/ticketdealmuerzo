<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets de Almuerzo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div class="text-6xl mb-4">‚è≥</div>
                <h2 class="text-2xl font-bold mb-2">Cargando...</h2>
                <p class="text-gray-600">Iniciando sistema...</p>
                <div class="mt-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDdjGkVMlGHnGMKunrnPSiG29VG-M9eCW4",
            authDomain: "ticketsalmuerzo.firebaseapp.com",
            projectId: "ticketsalmuerzo",
            storageBucket: "ticketsalmuerzo.firebasestorage.app",
            messagingSenderId: "865523116457",
            appId: "1:865523116457:web:63f5914ce980dff5647cb8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let userType = null;
        let employees = [];
        let tickets = [];
        let ticketUsage = [];
        
        const ADMIN_CODE = 'ADMIN2025';

        async function loadEmployees() {
            const snap = await getDocs(collection(db, 'employees'));
            employees = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            console.log('Empleados cargados:', employees.length);
        }

        async function loadTickets() {
            const snap = await getDocs(collection(db, 'tickets'));
            tickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            console.log('Tickets cargados:', tickets.length);
        }

        async function loadUsage() {
            const snap = await getDocs(collection(db, 'ticketUsage'));
            ticketUsage = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function formatLocalDate(dateStr, options = {}) {
            return parseLocalDate(dateStr).toLocaleDateString('es', options);
        }

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-[#1F4456] via-[#1F2533] to-[#570D4C] flex items-center justify-center p-4">
                    <div class="w-full max-w-md">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-4">
                            <div class="flex items-center justify-center">
                                <img src="https://i.postimg.cc/GmqQFp8Y/cp-endorsed-logo-san-jose-la-sabana-pos-horz-rgb.png" alt="Logo" class="h-20 w-auto object-contain">
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-2xl p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-3xl font-bold mb-2 text-[#1F2533]">Sistema de Tickets</h1>
                                <p class="text-[#C1CACF]">Control de Almuerzos</p>
                            </div>
                            <div id="loginBox"></div>
                        </div>
                        <div class="text-center mt-6">
                            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg px-6 py-3 inline-block border border-white border-opacity-20">
                                <p class="text-white text-sm font-medium">Creado por <span class="font-bold">Kelbin D.P</span></p>
                                <p class="text-[#C1CACF] text-xs mt-1">¬© ${new Date().getFullYear()} | Todos los derechos reservados</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showLoginButtons();
        }

        function showLoginButtons() {
            document.getElementById('loginBox').innerHTML = `
                <div class="space-y-3">
                    <button onclick="showQRInput()" class="w-full bg-[#1F4456] text-white py-4 rounded-lg hover:bg-[#1F2533] font-semibold transition-colors shadow-lg">üë• Acceso Colaboradores</button>
                    <button onclick="showQRInput('${ADMIN_CODE}')" class="w-full bg-[#570D4C] text-white py-4 rounded-lg hover:opacity-90 font-semibold transition-opacity shadow-lg">üîê Acceso Administrador</button>
                </div>
            `;
        }

        window.showQRInput = function(code = '') {
            document.getElementById('loginBox').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gradient-to-br from-[#C1CACF]/20 to-[#1F4456]/10 p-6 rounded-lg border-2 border-[#C1CACF]/30">
                        <div class="text-6xl text-center mb-4">üì±</div>
                        <input type="text" id="qrCode" value="${code}" placeholder="Ingresa tu c√≥digo de acceso" class="w-full p-3 border-2 border-[#C1CACF] rounded-lg text-center font-mono focus:border-[#1F4456] focus:ring-2 focus:ring-[#1F4456]/20 outline-none transition-all" autofocus>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="doLogin()" class="flex-1 bg-[#1F4456] text-white py-3 rounded-lg font-semibold hover:bg-[#1F2533] transition-colors shadow-lg">Acceder</button>
                        <button onclick="showLoginButtons()" class="flex-1 bg-[#C1CACF] text-[#1F2533] py-3 rounded-lg font-semibold hover:bg-[#C1CACF]/80 transition-colors">Cancelar</button>
                    </div>
                </div>
            `;
        };

        window.showLoginButtons = showLoginButtons;

        window.doLogin = async function() {
            const code = document.getElementById('qrCode').value.trim();
            if (code === ADMIN_CODE) {
                userType = 'admin';
                currentUser = { name: 'Administrador' };
                alert('‚úÖ Acceso admin correcto. Panel en desarrollo.');
            } else {
                const emp = employees.find(e => e.qrCode === code);
                if (emp) {
                    userType = 'employee';
                    currentUser = emp;
                    alert('‚úÖ Acceso empleado correcto: ' + emp.name);
                } else {
                    alert('‚ùå C√≥digo QR no v√°lido');
                }
            }
        };

        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadEmployees(), loadTickets(), loadUsage()]);
            renderLogin();
        });
    </script>
</body>
</html>
