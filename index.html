<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets de Almuerzo - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs';

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDdjGkVMlGHnGMKunrnPSiG29VG-M9eCW4",
            authDomain: "ticketsalmuerzo.firebaseapp.com",
            projectId: "ticketsalmuerzo",
            storageBucket: "ticketsalmuerzo.firebasestorage.app",
            messagingSenderId: "865523116457",
            appId: "1:865523116457:web:63f5914ce980dff5647cb8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado global
        let currentUser = null;
        let userType = null;
        let employees = [];
        let tickets = [];
        let ticketUsage = [];
        let selectedMonth = '2025-01';
        let dailyUsageExpanded = true;
        let currentSelectedDate = new Date().toISOString().split('T')[0];
        const ADMIN_CODE = 'ADMIN2025';
        let storageAvailable = true;

        // Verificar disponibilidad de localStorage
        function checkStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.error('localStorage no disponible:', e);
                return false;
            }
        }

        // Inicializar verificaci√≥n de storage
        storageAvailable = checkStorageAvailable();

        // Cargar datos desde Firebase
        async function loadEmployees() {
            const snap = await getDocs(collection(db, 'employees'));
            employees = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            console.log('Empleados cargados:', employees.length);
        }

        async function loadTickets() {
            const snap = await getDocs(collection(db, 'tickets'));
            tickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            console.log('Tickets cargados:', tickets.length);
        }

        async function loadUsage() {
            const snap = await getDocs(collection(db, 'ticketUsage'));
            ticketUsage = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        // Escuchar cambios en tiempo real
        onSnapshot(collection(db, 'employees'), () => { loadEmployees().then(() => { if (userType === 'admin') renderAdmin(); }); });
        onSnapshot(collection(db, 'tickets'), () => { loadTickets().then(() => { if (userType === 'admin') renderAdmin(); if (userType === 'employee') renderEmployee(); }); });
        onSnapshot(collection(db, 'ticketUsage'), () => { 
            loadUsage().then(() => { 
                if (userType === 'employee') renderEmployee(); 
                if (userType === 'admin' && document.getElementById('dailyUsageTable')) {
                    updateDailyUsage(currentSelectedDate);
                }
            }); 
        });

        // Utilidades
        function generateQR() {
            return `QR-EMP${Math.floor(Math.random() * 100000).toString().padStart(5, '0')}-${new Date().getFullYear()}`;
        }

        function generateTicketCode() {
            const d = new Date();
            return `TKT-${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
        }

        function getMonths() {
            const months = [];
            for (let i = 0; i < 24; i++) {
                const d = new Date(2025, i, 1);
                const key = d.toISOString().slice(0, 7);
                const name = d.toLocaleDateString('es', { month: 'long', year: 'numeric' });
                months.push({ key, name: name.charAt(0).toUpperCase() + name.slice(1) });
            }
            return months;
        }

        // Funci√≥n para parsear fecha sin problemas de zona horaria
        function parseLocalDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Funci√≥n para formatear fecha localmente
        function formatLocalDate(dateStr, options = {}) {
            return parseLocalDate(dateStr).toLocaleDateString('es', options);
        }

        // LOGIN
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                    <div class="w-full max-w-md">
                        <!-- Espacio para Logo -->
                        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-4">
                            <div id="logoContainer" class="flex items-center justify-center">
                                <img src="https://i.postimg.cc/V6yLjSWz/cp-endorsed-logo-san-jose-la-sabana-neg-horz-rgb.png" 
                                     alt="Logo" 
                                     class="h-24 w-auto"
                                     style="mix-blend-mode: multiply; filter: brightness(0);">
                            </div>
                        </div>
                        
                        <!-- Caja de Login -->
                        <div class="bg-white rounded-2xl shadow-2xl p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-3xl font-bold mb-2">Sistema de Tickets</h1>
                                <p class="text-gray-600">Control de Almuerzos</p>
                            </div>
                            <div id="loginBox"></div>
                        </div>
                        
                        <!-- Cr√©ditos -->
                        <div class="text-center mt-6">
                            <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg px-6 py-3 inline-block">
                                <p class="text-white text-sm font-medium">
                                    Creado por <span class="font-bold">Kelbin D.P</span>
                                </p>
                                <p class="text-white text-xs opacity-80 mt-1">
                                    ¬© ${new Date().getFullYear()} | Todos los derechos reservados
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showLoginButtons();
        }

        function showLoginButtons() {
            document.getElementById('loginBox').innerHTML = `
                <div class="space-y-3">
                    <button onclick="showQRInput('', true)" class="w-full bg-blue-600 text-white py-4 rounded-lg hover:bg-blue-700 font-semibold">
                        üë• Acceso Colaboradores
                    </button>
                    <button onclick="showQRInput('', false)" class="w-full bg-purple-600 text-white py-4 rounded-lg hover:bg-purple-700 font-semibold">
                        üîê Acceso Administrador
                    </button>
                </div>
            `;
        }

        window.showQRInput = function(code = '', showHistory = true) {
            const history = (showHistory && storageAvailable) ? getCodeHistory() : [];
            
            document.getElementById('loginBox').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                        <div class="text-6xl text-center mb-4">üì±</div>
                        <input type="text" id="qrCode" value="${code}" placeholder="Ingresa tu c√≥digo de acceso" 
                            class="w-full p-3 border-2 rounded-lg text-center font-mono" autofocus>
                    </div>
                    
                    ${showHistory && !storageAvailable ? `
                        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="text-2xl">‚ö†Ô∏è</div>
                                <div class="flex-1">
                                    <p class="font-bold text-sm mb-1">Historial no disponible</p>
                                    <p class="text-xs text-gray-700">
                                        Tu navegador tiene restricciones de privacidad que impiden guardar el historial de c√≥digos. 
                                        Puedes seguir usando la app normalmente, pero deber√°s ingresar tu c√≥digo cada vez.
                                    </p>
                                    <details class="mt-2">
                                        <summary class="text-xs text-blue-600 cursor-pointer hover:text-blue-800">¬øC√≥mo habilitarlo?</summary>
                                        <div class="text-xs text-gray-600 mt-2 space-y-1">
                                            <p><strong>Safari (iOS/Mac):</strong></p>
                                            <p>‚Ä¢ Ajustes ‚Üí Safari ‚Üí Desactivar "Evitar seguimiento entre sitios"</p>
                                            <p>‚Ä¢ O usa la app en modo normal (no privado)</p>
                                            <p class="mt-2"><strong>Chrome/Firefox:</strong></p>
                                            <p>‚Ä¢ Desactiva el modo inc√≥gnito/privado</p>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${showHistory && storageAvailable && history.length > 0 ? `
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-sm flex items-center gap-2">
                                    üïê C√≥digos Recientes (Este dispositivo)
                                </h3>
                                <button onclick="clearCodeHistory()" class="text-xs text-red-600 hover:text-red-800 font-semibold">
                                    üóëÔ∏è Limpiar
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${history.map(item => `
                                    <button onclick="selectHistoryCode('${item.code}')" 
                                        class="w-full bg-white hover:bg-purple-100 border-2 border-purple-200 rounded-lg p-3 text-left transition-all">
                                        <div class="flex justify-between items-center">
                                            <div class="flex-1">
                                                <p class="font-semibold text-sm">${item.name}</p>
                                                <p class="text-xs text-gray-600 font-mono">${item.code}</p>
                                            </div>
                                            <div class="text-2xl">‚Üí</div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            <p class="text-xs text-gray-600 mt-3 text-center">
                                ‚ö†Ô∏è Este historial es privado de este dispositivo
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="doLogin()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">Acceder</button>
                        <button onclick="showLoginButtons()" class="flex-1 bg-gray-300 py-3 rounded-lg font-semibold">Cancelar</button>
                    </div>
                </div>
            `;
        };

        window.selectHistoryCode = function(code) {
            document.getElementById('qrCode').value = code;
            document.getElementById('qrCode').focus();
        };

        window.showLoginButtons = showLoginButtons;

        window.doLogin = async function() {
            const code = document.getElementById('qrCode').value.trim();
            
            if (code === ADMIN_CODE) {
                userType = 'admin';
                currentUser = { name: 'Administrador' };
                await Promise.all([loadEmployees(), loadTickets(), loadUsage()]);
                
                // Guardar sesi√≥n (intentar, pero no bloquear si falla)
                if (storageAvailable) {
                    try {
                        localStorage.setItem('ticketSystem_userType', 'admin');
                        localStorage.setItem('ticketSystem_userCode', code);
                        console.log('Sesi√≥n admin guardada');
                    } catch (error) {
                        console.error('No se pudo guardar la sesi√≥n:', error);
                        storageAvailable = false;
                    }
                }
                
                renderAdmin();
            } else {
                const emp = employees.find(e => e.qrCode === code);
                if (emp) {
                    userType = 'employee';
                    currentUser = emp;
                    await Promise.all([loadTickets(), loadUsage()]);
                    
                    // Guardar en historial (intentar, pero no bloquear si falla)
                    saveCodeToHistory(code, emp.name);
                    
                    // Guardar sesi√≥n (intentar, pero no bloquear si falla)
                    if (storageAvailable) {
                        try {
                            localStorage.setItem('ticketSystem_userType', 'employee');
                            localStorage.setItem('ticketSystem_userId', emp.id);
                            localStorage.setItem('ticketSystem_userCode', code);
                            localStorage.setItem('ticketSystem_userName', emp.name);
                            console.log('Sesi√≥n empleado guardada:', emp.name);
                        } catch (error) {
                            console.error('No se pudo guardar la sesi√≥n:', error);
                            storageAvailable = false;
                        }
                    }
                    
                    renderEmployee();
                } else {
                    alert('C√≥digo QR no v√°lido');
                }
            }
        };

        // Funci√≥n para guardar c√≥digo en historial
        function saveCodeToHistory(code, name) {
            if (!storageAvailable) {
                console.log('Historial no disponible - localStorage bloqueado');
                return;
            }
            
            try {
                let history = JSON.parse(localStorage.getItem('ticketSystem_codeHistory') || '[]');
                
                // Remover si ya existe (para moverlo al principio)
                history = history.filter(item => item.code !== code);
                
                // Agregar al principio
                history.unshift({ code, name, date: new Date().toISOString() });
                
                // Mantener solo los √∫ltimos 5
                history = history.slice(0, 5);
                
                localStorage.setItem('ticketSystem_codeHistory', JSON.stringify(history));
                console.log('C√≥digo guardado en historial:', name);
            } catch (error) {
                console.error('Error al guardar historial:', error);
                storageAvailable = false; // Marcar como no disponible
            }
        }

        // Funci√≥n para obtener historial
        function getCodeHistory() {
            if (!storageAvailable) {
                return [];
            }
            
            try {
                const history = JSON.parse(localStorage.getItem('ticketSystem_codeHistory') || '[]');
                return history;
            } catch (error) {
                console.error('Error al leer historial:', error);
                storageAvailable = false;
                return [];
            }
        }

        // Funci√≥n para limpiar historial
        window.clearCodeHistory = function() {
            if (!storageAvailable) {
                alert('‚ö†Ô∏è El historial no est√° disponible en este navegador debido a las configuraciones de privacidad.');
                return;
            }
            
            if (confirm('¬øEliminar todo el historial de c√≥digos de este dispositivo?')) {
                try {
                    localStorage.removeItem('ticketSystem_codeHistory');
                    showQRInput('', true);
                    alert('‚úÖ Historial limpiado');
                } catch (error) {
                    console.error('Error al limpiar historial:', error);
                    alert('‚ùå Error al limpiar el historial');
                }
            }
        };

        window.logout = function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                currentUser = null;
                userType = null;
                
                // Limpiar sesi√≥n guardada (pero NO el historial)
                if (storageAvailable) {
                    try {
                        localStorage.removeItem('ticketSystem_userType');
                        localStorage.removeItem('ticketSystem_userId');
                        localStorage.removeItem('ticketSystem_userCode');
                        localStorage.removeItem('ticketSystem_userName');
                        // NO limpiar: ticketSystem_codeHistory
                        console.log('Sesi√≥n cerrada (historial preservado)');
                    } catch (error) {
                        console.error('Error al limpiar sesi√≥n:', error);
                    }
                }
                
                renderLogin();
            }
        };

        // PANEL EMPLEADO
        function renderEmployee() {
            const activeTicket = tickets.find(t => t.employeeId === currentUser.id && t.status === 'active');
            const myUsage = ticketUsage.filter(u => u.employeeId === currentUser.id).sort((a, b) => parseLocalDate(b.date) - parseLocalDate(a.date));
            const isExpired = activeTicket ? parseLocalDate(activeTicket.expirationDate) < new Date() : false;
            const ticketsExhausted = activeTicket && activeTicket.hasLimit && (activeTicket.usedDays || 0) >= activeTicket.maxTickets;

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-600 text-white p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold">Mi √Årea Personal</h1>
                            <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700">üö™ Salir</button>
                        </div>
                    </div>
                    <div class="container mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="bg-blue-50 p-4 rounded mb-6">
                                <p class="text-lg"><strong>Bienvenido:</strong> ${currentUser.name}</p>
                                <p><strong>Departamento:</strong> ${currentUser.department}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <p class="text-sm text-gray-600">QR: ${currentUser.qrCode}</p>
                                    <button onclick="showQRCode('${currentUser.qrCode}', '${currentUser.name}')" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        Ver QR üì±
                                    </button>
                                </div>
                            </div>
                            ${activeTicket ? `
                                <div class="relative bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl shadow-2xl overflow-hidden mb-6">
                                    ${isExpired ? '<div class="absolute inset-0 flex items-center justify-center z-10"><div class="text-red-600 font-black text-8xl opacity-20 transform -rotate-45">VENCIDO</div></div>' : ''}
                                    ${ticketsExhausted ? '<div class="absolute inset-0 flex items-center justify-center z-10"><div class="text-orange-600 font-black text-7xl opacity-20 transform -rotate-45">AGOTADOS</div></div>' : ''}
                                    <div class="p-8 text-white relative">
                                        <div class="mb-6">
                                            <p class="text-sm uppercase opacity-80">Ticket de Almuerzo</p>
                                            <p class="font-mono text-lg">${activeTicket.ticketCode}</p>
                                        </div>
                                        <div class="mb-6">
                                            <p class="text-sm opacity-80">Colaborador</p>
                                            <p class="text-3xl font-bold">${currentUser.name}</p>
                                        </div>
                                        <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-6">
                                            <p class="text-sm opacity-90 mb-1">Fecha de Caducidad</p>
                                            <p class="text-4xl font-black">${formatLocalDate(activeTicket.expirationDate, {day:'2-digit', month:'short', year:'numeric'}).toUpperCase()}</p>
                                        </div>
                                        ${activeTicket.hasLimit ? `
                                            <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-6">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-sm opacity-90">Tickets Disponibles</span>
                                                    <span class="text-2xl font-black">${Math.max(0, activeTicket.maxTickets - (activeTicket.usedDays || 0))} / ${activeTicket.maxTickets}</span>
                                                </div>
                                                <div class="w-full bg-white bg-opacity-30 rounded-full h-3 overflow-hidden">
                                                    <div class="bg-white h-full rounded-full transition-all duration-300" style="width: ${Math.min(100, ((activeTicket.usedDays || 0) / activeTicket.maxTickets) * 100)}%"></div>
                                                </div>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between text-sm opacity-80">
                                            <span>D√≠as usados: ${activeTicket.usedDays || 0}</span>
                                            <span>${!isExpired && !ticketsExhausted ? '‚óè ACTIVO' : '‚óã INACTIVO'}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="useTicketNow()" ${ticketsExhausted || isExpired ? 'disabled' : ''} class="w-full ${ticketsExhausted || isExpired ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'} text-white py-4 rounded-lg font-semibold mb-6">
                                    ${ticketsExhausted ? 'üö´ Tickets Agotados - Contacta al administrador' : isExpired ? 'üö´ Ticket Vencido' : '‚úì Usar Ticket Hoy'}
                                </button>
                                <div class="border rounded-lg p-4">
                                    <h3 class="font-bold mb-4">üìä Historial</h3>
                                    ${myUsage.length > 0 ? myUsage.map(u => `
                                        <div class="flex justify-between bg-gray-50 p-3 rounded mb-2">
                                            <span>${formatLocalDate(u.date)}</span>
                                            <span class="text-sm text-gray-600">${u.time}</span>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-center py-4">Sin usos</p>'}
                                </div>
                            ` : '<div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-8 text-center"><p class="text-xl font-semibold">No tienes ticket activo</p></div>'}
                        </div>
                    </div>
                    <div id="popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"></div>
                    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"></div>
                </div>
            `;
            
            // Inicializar el uso diario con la fecha de hoy
            setTimeout(() => {
                updateDailyUsage(new Date().toISOString().split('T')[0]);
            }, 100);
        }

        window.toggleDailyUsage = function() {
            dailyUsageExpanded = !dailyUsageExpanded;
            const container = document.getElementById('dailyUsageContainer');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            if (dailyUsageExpanded) {
                container.style.display = 'block';
                icon.textContent = '‚ñº';
                text.textContent = 'Minimizar';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñ∂';
                text.textContent = 'Expandir';
            }
        };

        window.updateDailyUsage = function(selectedDate) {
            currentSelectedDate = selectedDate;
            const dayUsage = ticketUsage.filter(u => u.date === selectedDate);
            const count = dayUsage.length;
            
            const countElement = document.getElementById('dailyCount');
            if (countElement) {
                countElement.textContent = count;
            }
            
            const tableElement = document.getElementById('dailyUsageTable');
            if (!tableElement) return;
            
            if (count === 0) {
                tableElement.innerHTML = `
                    <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <p class="text-gray-500">üì≠ No hay tickets usados en esta fecha</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por hora
            dayUsage.sort((a, b) => {
                const timeA = a.time.split(':').map(Number);
                const timeB = b.time.split(':').map(Number);
                return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
            });
            
            let tableHtml = `
                <div class="bg-white border-2 border-cyan-200 rounded-lg overflow-hidden">
                    <div class="bg-cyan-100 p-3 font-bold border-b-2 border-cyan-200 flex justify-between items-center">
                        <span>Lista de usos del d√≠a - ${formatLocalDate(selectedDate, {weekday:'long', day:'numeric', month:'long', year:'numeric'})}</span>
                        <span class="bg-cyan-600 text-white px-3 py-1 rounded-full text-sm">${count} registros</span>
                    </div>
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">#</th>
                                <th class="p-3 text-left">Hora</th>
                                <th class="p-3 text-left">Colaborador</th>
                                <th class="p-3 text-left">Departamento</th>
                                <th class="p-3 text-left">ID</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            dayUsage.forEach((usage, index) => {
                const emp = employees.find(e => e.id === usage.employeeId);
                if (emp) {
                    tableHtml += `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="p-3 font-semibold text-gray-500">${index + 1}</td>
                            <td class="p-3">
                                <span class="bg-blue-100 px-3 py-1 rounded-full font-mono font-semibold text-blue-700">
                                    ${usage.time}
                                </span>
                            </td>
                            <td class="p-3 font-semibold">${emp.name}</td>
                            <td class="p-3 text-gray-600">${emp.department}</td>
                            <td class="p-3 text-sm text-gray-500">${emp.employeeId}</td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableElement.innerHTML = tableHtml;
        };

        window.useTicketNow = async function() {
            const today = new Date().toISOString().split('T')[0];
            const ticket = tickets.find(t => t.employeeId === currentUser.id && t.status === 'active' && parseLocalDate(t.expirationDate) >= new Date());
            
            if (!ticket) { alert('No tienes ticket activo'); return; }
            if (ticketUsage.find(u => u.employeeId === currentUser.id && u.date === today)) { alert('Ya usaste tu ticket hoy'); return; }
            
            // Verificar si tiene l√≠mite y si se agotaron
            if (ticket.hasLimit && (ticket.usedDays || 0) >= ticket.maxTickets) {
                alert('üö´ Tickets agotados. Contacta con el administrador.');
                return;
            }

            document.getElementById('popup').innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">‚úÖ</div>
                        <h2 class="text-2xl font-bold text-green-600">Ticket V√°lido</h2>
                    </div>
                    <div class="bg-green-100 rounded-xl p-6 mb-6 border-2 border-green-300">
                        <p class="text-center text-sm text-gray-600 mb-2">Fecha</p>
                        <p class="text-3xl font-black text-green-700 text-center">${formatLocalDate(today, {weekday:'long', day:'2-digit', month:'long', year:'numeric'}).toUpperCase()}</p>
                        <div class="border-t-2 border-green-300 mt-4 pt-4">
                            <p class="text-center text-sm"><strong>${currentUser.name}</strong></p>
                            <p class="text-center text-xs text-gray-600">${ticket.ticketCode}</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmUse('${ticket.id}', '${today}')" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">Confirmar</button>
                        <button onclick="closePopup()" class="flex-1 bg-gray-300 py-3 rounded-lg font-semibold">Cancelar</button>
                    </div>
                </div>
            `;
            document.getElementById('popup').classList.remove('hidden');
        };

        window.confirmUse = async function(ticketId, date) {
            const now = new Date();
            await addDoc(collection(db, 'ticketUsage'), {
                ticketId, 
                employeeId: currentUser.id, 
                date, 
                time: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`
            });
            const ticket = tickets.find(t => t.id === ticketId);
            await updateDoc(doc(db, 'tickets', ticketId), { usedDays: (ticket.usedDays || 0) + 1 });
            closePopup();
            alert('‚úÖ Ticket usado');
        };

        window.closePopup = function() {
            document.getElementById('popup').classList.add('hidden');
        };

        // PANEL ADMIN
        function renderAdmin() {
            const months = getMonths();
            const monthEmps = employees.filter(e => e.registrationDate && e.registrationDate.slice(0, 7) === selectedMonth);
            const monthTickets = tickets.filter(t => t.requestDate && t.requestDate.slice(0, 7) === selectedMonth);

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-600 text-white p-4">
                        <div class="container mx-auto flex justify-between">
                            <h1 class="text-2xl font-bold">Panel Admin</h1>
                            <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700">üö™ Salir</button>
                        </div>
                    </div>
                    <div class="container mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="mb-6 flex gap-2 items-center flex-wrap">
                                <select onchange="changeMonth(this.value)" class="p-3 border-2 rounded-lg font-semibold">
                                    ${months.map(m => `<option value="${m.key}" ${m.key === selectedMonth ? 'selected' : ''}>${m.name}</option>`).join('')}
                                </select>
                                <button onclick="cleanDB()" class="bg-red-600 text-white px-4 py-2 rounded-lg">üóëÔ∏è Limpiar BD</button>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-100 p-4 rounded">
                                    <p class="text-sm">Colaboradores</p>
                                    <p class="text-3xl font-bold">${monthEmps.length}</p>
                                </div>
                                <div class="bg-purple-100 p-4 rounded">
                                    <p class="text-sm">Tickets</p>
                                    <p class="text-3xl font-bold">${monthTickets.length}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded">
                                    <p class="text-sm">Activos</p>
                                    <p class="text-3xl font-bold">${monthTickets.filter(t => t.status === 'active').length}</p>
                                </div>
                                <div class="bg-orange-100 p-4 rounded">
                                    <p class="text-sm">Total BD</p>
                                    <p class="text-3xl font-bold">${employees.length}</p>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-200 rounded-lg p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold flex items-center gap-2">
                                        üìä Control de Uso Diario
                                    </h3>
                                    <button onclick="toggleDailyUsage()" id="toggleDailyBtn" 
                                        class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 flex items-center gap-2">
                                        <span id="toggleIcon">‚ñº</span>
                                        <span id="toggleText">Minimizar</span>
                                    </button>
                                </div>
                                <div class="flex gap-3 items-end flex-wrap">
                                    <div class="flex-1 min-w-64">
                                        <label class="block text-sm font-semibold mb-2">Seleccionar fecha:</label>
                                        <input type="date" id="usageDate" value="${new Date().toISOString().split('T')[0]}" 
                                            onchange="updateDailyUsage(this.value)"
                                            class="w-full p-3 border-2 rounded-lg">
                                    </div>
                                    <div class="bg-white rounded-lg p-4 border-2 border-cyan-300">
                                        <p class="text-sm text-gray-600">Tickets usados</p>
                                        <p class="text-4xl font-black text-cyan-600" id="dailyCount">0</p>
                                    </div>
                                </div>
                                <div id="dailyUsageContainer" class="mt-4">
                                    <div id="dailyUsageTable"></div>
                                </div>
                            </div>

                            <div class="flex gap-2 mb-4 flex-wrap">
                                <button onclick="showAddEmp()" class="bg-blue-600 text-white px-6 py-3 rounded-lg">‚ûï Agregar</button>
                                <button onclick="showUploadExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg">üì§ Cargar Excel</button>
                                <button onclick="printAllQRs()" class="bg-purple-600 text-white px-6 py-3 rounded-lg">üñ®Ô∏è Imprimir QRs</button>
                            </div>
                            
                            <div class="border rounded-lg overflow-hidden mb-6">
                                <div class="p-4 bg-gray-50 flex justify-between items-center flex-wrap gap-3">
                                    <span class="font-bold">Colaboradores (${monthEmps.length})</span>
                                    <input type="text" id="searchEmp" placeholder="üîç Buscar por ID o nombre..." 
                                        oninput="filterEmps(this.value)" 
                                        class="px-4 py-2 border-2 rounded-lg">
                                </div>
                                <table class="w-full">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-left">ID</th>
                                            <th class="p-3 text-left">Nombre</th>
                                            <th class="p-3 text-left">Dept</th>
                                            <th class="p-3 text-left">QR</th>
                                            <th class="p-3 text-left">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="empTable">
                                        ${monthEmps.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-500">Sin colaboradores</td></tr>' :
                                        monthEmps.map(e => `
                                            <tr class="border-t emp-row" data-id="${e.employeeId.toLowerCase()}" data-name="${e.name.toLowerCase()}">
                                                <td class="p-3">${e.employeeId}</td>
                                                <td class="p-3">${e.name}</td>
                                                <td class="p-3">${e.department}</td>
                                                <td class="p-3"><code class="bg-gray-100 px-2 py-1 rounded text-sm">${e.qrCode}</code></td>
                                                <td class="p-3">
                                                    <button onclick="showAddTicket('${e.id}')" class="text-green-600 text-xl mr-2" title="Crear Ticket">‚ûï</button>
                                                    <button onclick="showQRCode('${e.qrCode}', '${e.name}')" class="text-blue-600 text-xl mr-2" title="Ver QR">üì±</button>
                                                    <button onclick="deleteEmp('${e.id}', '${e.name}')" class="text-red-600 text-xl" title="Eliminar">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div class="border rounded-lg overflow-hidden">
                                <div class="p-4 bg-gray-50 flex justify-between items-center flex-wrap gap-3">
                                    <span class="font-bold">Tickets (${monthTickets.length})</span>
                                    <input type="text" id="searchTicket" placeholder="üîç Buscar por colaborador..." 
                                        oninput="filterTickets(this.value)" 
                                        class="px-4 py-2 border-2 rounded-lg">
                                </div>
                                <table class="w-full">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-left">C√≥digo</th>
                                            <th class="p-3 text-left">Colaborador</th>
                                            <th class="p-3 text-left">Estado</th>
                                            <th class="p-3 text-left">Caducidad</th>
                                            <th class="p-3 text-left">Usos</th>
                                            <th class="p-3 text-left">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ticketTable">
                                        ${monthTickets.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-gray-500">Sin tickets</td></tr>' :
                                        monthTickets.map(t => {
                                            const emp = employees.find(e => e.id === t.employeeId);
                                            const expired = parseLocalDate(t.expirationDate) < new Date();
                                            const exhausted = t.hasLimit && (t.usedDays || 0) >= t.maxTickets;
                                            const nearLimit = t.hasLimit && !exhausted && ((t.usedDays || 0) / t.maxTickets) >= 0.8;
                                            const statusColor = exhausted ? 'bg-orange-100 text-orange-800' : (!expired ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
                                            const statusText = exhausted ? 'AGOTADO' : (!expired ? 'ACTIVO' : 'EXPIRADO');
                                            return `
                                                <tr class="border-t ticket-row ${nearLimit ? 'bg-yellow-50' : ''}" data-emp="${(emp?.name || '').toLowerCase()}">
                                                    <td class="p-3 font-mono text-sm">${t.ticketCode}</td>
                                                    <td class="p-3">${emp?.name || 'N/A'}</td>
                                                    <td class="p-3"><span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${statusText}</span></td>
                                                    <td class="p-3">${formatLocalDate(t.expirationDate)}</td>
                                                    <td class="p-3">
                                                        <span class="bg-blue-100 px-3 py-1 rounded-full font-semibold ${nearLimit ? 'bg-yellow-200 text-yellow-900' : ''}">
                                                            ${t.usedDays || 0}${t.hasLimit ? ` / ${t.maxTickets}` : ''}
                                                        </span>
                                                        ${t.hasLimit ? '<span class="ml-2 text-xs text-gray-500">üéØ</span>' : ''}
                                                        ${nearLimit ? '<span class="ml-2 text-xs text-yellow-600">‚ö†Ô∏è</span>' : ''}
                                                    </td>
                                                    <td class="p-3">
                                                        ${t.hasLimit ? `<button onclick="modifyTicketLimit('${t.id}', ${t.maxTickets}, ${t.usedDays || 0})" class="text-blue-600 text-xl mr-2" title="Modificar cantidad">‚úèÔ∏è</button>` : ''}
                                                        <button onclick="deleteTicket('${t.id}', '${t.ticketCode}')" class="text-red-600 text-xl" title="Eliminar">üóëÔ∏è</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"></div>
                </div>
            `;
        }

        window.changeMonth = function(month) {
            selectedMonth = month;
            renderAdmin();
        };

        window.showAddEmp = function() {
            document.getElementById('modal').innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-2xl font-bold mb-4">Agregar Colaborador</h3>
                    <div class="bg-blue-50 p-3 rounded mb-4">
                        <p class="text-sm font-semibold">üìÖ Se registrar√° en: ${getMonths().find(m => m.key === selectedMonth)?.name}</p>
                    </div>
                    <input type="text" id="name" placeholder="Nombre" class="w-full p-3 border rounded-lg mb-3">
                    <input type="text" id="empId" placeholder="ID" class="w-full p-3 border rounded-lg mb-3">
                    <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded-lg mb-3">
                    <input type="text" id="dept" placeholder="Departamento" class="w-full p-3 border rounded-lg mb-3">
                    <div class="flex gap-2">
                        <button onclick="saveEmp()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg">Agregar</button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 py-3 rounded-lg">Cancelar</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.saveEmp = async function() {
            const name = document.getElementById('name').value.trim();
            const employeeId = document.getElementById('empId').value.trim();
            const email = document.getElementById('email').value.trim();
            const department = document.getElementById('dept').value.trim();
            
            if (!name || !employeeId || !email || !department) { alert('Completa todos los campos'); return; }
            
            await addDoc(collection(db, 'employees'), {
                name, employeeId, email, department,
                qrCode: generateQR(),
                registrationDate: `${selectedMonth}-01`
            });
            closeModal();
        };

        window.showUploadExcel = function() {
            document.getElementById('modal').innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full">
                    <h3 class="text-2xl font-bold mb-4">üì§ Cargar Colaboradores desde Excel</h3>
                    
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                        <p class="font-semibold mb-2">üìã Formato del Excel:</p>
                        <div class="text-sm space-y-1">
                            <p>‚Ä¢ <strong>Columna A:</strong> Nombre</p>
                            <p>‚Ä¢ <strong>Columna B:</strong> ID</p>
                            <p>‚Ä¢ <strong>Columna C:</strong> Email</p>
                            <p>‚Ä¢ <strong>Columna D:</strong> Departamento</p>
                        </div>
                        <p class="text-xs text-gray-600 mt-3">üí° La primera fila puede ser encabezados (se ignorar√°)</p>
                    </div>

                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm">üìÖ Se registrar√°n en: <strong>${getMonths().find(m => m.key === selectedMonth)?.name}</strong></p>
                    </div>

                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 hover:border-blue-500 transition-colors">
                        <div class="text-6xl mb-4">üìÇ</div>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
                        <label for="excelFile" class="cursor-pointer">
                            <span class="bg-blue-600 text-white px-6 py-3 rounded-lg inline-block hover:bg-blue-700">
                                Seleccionar archivo Excel
                            </span>
                        </label>
                        <p class="text-sm text-gray-500 mt-3">Formatos: .xlsx, .xls</p>
                    </div>

                    <div id="previewContainer" class="hidden mb-4">
                        <h4 class="font-bold mb-2">Vista previa:</h4>
                        <div class="border rounded-lg overflow-auto max-h-60">
                            <table class="w-full text-sm" id="previewTable"></table>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Total: <span id="totalRows" class="font-bold">0</span> colaboradores</p>
                    </div>

                    <div class="flex gap-2">
                        <button id="uploadBtn" onclick="uploadEmployees()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold" disabled>
                            Cargar Colaboradores
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 py-3 rounded-lg font-semibold">Cancelar</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        };

        let excelData = [];

        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Procesar datos (omitir primera fila si parece ser encabezado)
                let startRow = 0;
                if (jsonData[0] && typeof jsonData[0][0] === 'string' && 
                    (jsonData[0][0].toLowerCase().includes('nombre') || 
                     jsonData[0][0].toLowerCase().includes('name'))) {
                    startRow = 1;
                }

                excelData = [];
                for (let i = startRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row && row[0] && row[1]) { // Al menos nombre e ID
                        excelData.push({
                            name: String(row[0] || '').trim(),
                            employeeId: String(row[1] || '').trim(),
                            email: String(row[2] || '').trim(),
                            department: String(row[3] || '').trim()
                        });
                    }
                }

                // Mostrar vista previa
                if (excelData.length > 0) {
                    showPreview(excelData);
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    alert('No se encontraron datos v√°lidos en el archivo');
                }

            } catch (error) {
                console.error('Error al leer Excel:', error);
                alert('Error al leer el archivo. Verifica que sea un Excel v√°lido.');
            }
        };

        function showPreview(data) {
            const preview = data.slice(0, 10); // Mostrar primeros 10
            let html = `
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 text-left">Nombre</th>
                        <th class="p-2 text-left">ID</th>
                        <th class="p-2 text-left">Email</th>
                        <th class="p-2 text-left">Departamento</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            preview.forEach(emp => {
                html += `
                    <tr class="border-t">
                        <td class="p-2">${emp.name}</td>
                        <td class="p-2">${emp.employeeId}</td>
                        <td class="p-2">${emp.email}</td>
                        <td class="p-2">${emp.department}</td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            document.getElementById('previewTable').innerHTML = html;
            document.getElementById('totalRows').textContent = data.length;
            document.getElementById('previewContainer').classList.remove('hidden');
        }

        window.uploadEmployees = async function() {
            if (excelData.length === 0) {
                alert('No hay datos para cargar');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'Cargando...';

            let added = 0;
            let errors = 0;

            for (const emp of excelData) {
                try {
                    if (emp.name && emp.employeeId && emp.email && emp.department) {
                        await addDoc(collection(db, 'employees'), {
                            name: emp.name,
                            employeeId: emp.employeeId,
                            email: emp.email,
                            department: emp.department,
                            qrCode: generateQR(),
                            registrationDate: `${selectedMonth}-01`
                        });
                        added++;
                    } else {
                        errors++;
                    }
                } catch (error) {
                    console.error('Error al agregar empleado:', error);
                    errors++;
                }
            }

            alert(`‚úÖ Carga completada!\n\n‚úì Agregados: ${added}\n${errors > 0 ? `‚úó Errores: ${errors}` : ''}`);
            closeModal();
            excelData = [];
        };

        window.showAddTicket = function(empId) {
            const emp = employees.find(e => e.id === empId);
            document.getElementById('modal').innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-2xl font-bold mb-4">Crear Ticket</h3>
                    <div class="bg-blue-50 p-4 rounded mb-4">
                        <p><strong>Colaborador:</strong> ${emp.name}</p>
                        <p class="text-sm text-blue-700">üìÖ Mes: ${getMonths().find(m => m.key === selectedMonth)?.name}</p>
                    </div>
                    <input type="date" id="expDate" class="w-full p-3 border rounded-lg mb-3" min="${new Date().toISOString().split('T')[0]}">
                    
                    <div class="bg-gray-50 border rounded-lg p-4 mb-3">
                        <label class="flex items-center cursor-pointer mb-3">
                            <input type="checkbox" id="hasLimit" onchange="toggleLimitInput()" class="w-5 h-5 mr-3">
                            <span class="font-semibold">üéØ Limitar cantidad de tickets</span>
                        </label>
                        <div id="limitContainer" class="hidden">
                            <label class="block text-sm text-gray-600 mb-2">Cantidad m√°xima de tickets:</label>
                            <input type="number" id="maxTickets" min="1" max="100" value="20" class="w-full p-3 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-2">üí° El colaborador solo podr√° usar esta cantidad de tickets</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="saveTicket('${empId}')" class="flex-1 bg-blue-600 text-white py-3 rounded-lg">Crear</button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 py-3 rounded-lg">Cancelar</button>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.toggleLimitInput = function() {
            const checkbox = document.getElementById('hasLimit');
            const container = document.getElementById('limitContainer');
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };

        window.saveTicket = async function(empId) {
            const expDate = document.getElementById('expDate').value;
            if (!expDate) { alert('Selecciona fecha'); return; }
            
            const hasLimit = document.getElementById('hasLimit').checked;
            const maxTickets = hasLimit ? parseInt(document.getElementById('maxTickets').value) : null;
            
            if (hasLimit && (!maxTickets || maxTickets < 1)) {
                alert('Ingresa una cantidad v√°lida de tickets');
                return;
            }
            
            const ticketData = {
                employeeId: empId,
                ticketCode: generateTicketCode(),
                status: 'active',
                requestDate: `${selectedMonth}-01`,
                approvalDate: `${selectedMonth}-01`,
                expirationDate: expDate,
                usedDays: 0,
                hasLimit: hasLimit,
            };
            
            if (hasLimit) {
                ticketData.maxTickets = maxTickets;
            }
            
            await addDoc(collection(db, 'tickets'), ticketData);
            closeModal();
        };

        window.modifyTicketLimit = function(ticketId, currentMax, usedDays) {
            const ticket = tickets.find(t => t.id === ticketId);
            const emp = employees.find(e => e.id === ticket.employeeId);
            const remaining = currentMax - usedDays;
            
            document.getElementById('modal').innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-2xl font-bold mb-4">‚úèÔ∏è Modificar Cantidad de Tickets</h3>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="font-semibold mb-2">${emp?.name || 'N/A'}</p>
                        <p class="text-sm text-gray-700">C√≥digo: <span class="font-mono">${ticket.ticketCode}</span></p>
                    </div>

                    <div class="bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-200 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Total Actual</p>
                                <p class="text-2xl font-black text-cyan-600">${currentMax}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Usados</p>
                                <p class="text-2xl font-black text-orange-600">${usedDays}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Disponibles</p>
                                <p class="text-2xl font-black text-green-600">${remaining}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Nueva cantidad total de tickets:</label>
                        <input type="number" id="newMaxTickets" value="${currentMax}" min="${usedDays}" max="500" 
                            class="w-full p-3 border-2 rounded-lg text-center text-2xl font-bold">
                        <p class="text-xs text-gray-600 mt-2">
                            üí° M√≠nimo: ${usedDays} (ya usados) | Nuevo disponible: <span id="newAvailable" class="font-bold text-green-600">${remaining}</span>
                        </p>
                    </div>

                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 mb-4">
                        <p class="text-xs text-gray-700">
                            <strong>‚ö†Ô∏è Nota:</strong> Solo puedes aumentar la cantidad. No se puede reducir por debajo de los tickets ya usados (${usedDays}).
                        </p>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="saveTicketModification('${ticketId}', ${usedDays})" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold">
                            Guardar Cambios
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 py-3 rounded-lg font-semibold">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal').classList.remove('hidden');
            
            // Actualizar disponibles en tiempo real
            document.getElementById('newMaxTickets').addEventListener('input', function() {
                const newMax = parseInt(this.value) || 0;
                const newAvailable = Math.max(0, newMax - usedDays);
                document.getElementById('newAvailable').textContent = newAvailable;
            });
        };

        window.saveTicketModification = async function(ticketId, usedDays) {
            const newMax = parseInt(document.getElementById('newMaxTickets').value);
            
            if (!newMax || newMax < usedDays) {
                alert(`‚ùå La cantidad debe ser al menos ${usedDays} (tickets ya usados)`);
                return;
            }
            
            if (newMax > 500) {
                alert('‚ùå La cantidad m√°xima es 500 tickets');
                return;
            }
            
            try {
                await updateDoc(doc(db, 'tickets', ticketId), {
                    maxTickets: newMax
                });
                
                closeModal();
                alert(`‚úÖ Cantidad actualizada: ${newMax} tickets totales`);
            } catch (error) {
                console.error('Error al actualizar ticket:', error);
                alert('‚ùå Error al actualizar la cantidad');
            }
        };

        window.closeModal = function() {
            document.getElementById('modal').classList.add('hidden');
        };

        // FUNCIONES DE QR CODE
        window.showQRCode = function(qrCode, empName) {
            // URL fija de GitHub Pages
            const baseUrl = 'https://kelbinvdp.github.io/ticketdealmuerzo';
            const loginUrl = `${baseUrl}?qr=${encodeURIComponent(qrCode)}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(loginUrl)}`;
            
            console.log('URL del QR:', loginUrl); // Para debugging
            
            document.getElementById('modal').innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-2xl font-bold mb-4 text-center">C√≥digo QR</h3>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4 text-center">
                        <p class="font-semibold text-lg mb-2">${empName}</p>
                        <p class="text-sm text-gray-600">Escanea para acceder autom√°ticamente</p>
                    </div>

                    <div class="bg-white border-4 border-blue-500 rounded-lg p-6 mb-4 flex justify-center">
                        <img src="${qrUrl}" alt="QR Code" class="w-64 h-64" />
                    </div>

                    <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-4">
                        <p class="text-xs text-gray-600 mb-2 text-center">C√≥digo de acceso:</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="qrCodeText" value="${qrCode}" readonly 
                                class="flex-1 p-3 border-2 rounded-lg text-center font-mono bg-white text-lg font-bold">
                            <button onclick="copyQRCode()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 flex-shrink-0" title="Copiar">
                                üìã
                            </button>
                        </div>
                        <p id="copyMessage" class="text-xs text-green-600 text-center mt-2 hidden">‚úì Copiado al portapapeles</p>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="downloadQR('${qrUrl}', '${qrCode}')" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold">
                            üì• Descargar QR
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 py-3 rounded-lg font-semibold">
                            Cerrar
                        </button>
                    </div>

                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-gray-700">
                            <strong>üí° Instrucciones:</strong><br>
                            1. Escanea el QR con tu c√°mara<br>
                            2. Se abrir√° el login autom√°ticamente<br>
                            3. Acceso inmediato a tu cuenta
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.copyQRCode = async function() {
            const codeText = document.getElementById('qrCodeText').value;
            const message = document.getElementById('copyMessage');
            
            try {
                // Intentar m√©todo moderno (funciona en la mayor√≠a de navegadores)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(codeText);
                } else {
                    // Fallback para navegadores antiguos o iOS Safari
                    const textArea = document.createElement('textarea');
                    textArea.value = codeText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        textArea.remove();
                    } catch (err) {
                        console.error('Error al copiar:', err);
                        textArea.remove();
                        alert('No se pudo copiar. Por favor, copia manualmente el c√≥digo.');
                        return;
                    }
                }
                
                // Mostrar mensaje de √©xito
                message.classList.remove('hidden');
                setTimeout(() => {
                    message.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar autom√°ticamente. Por favor, selecciona y copia el c√≥digo manualmente.');
            }
        };

        window.downloadQR = async function(qrUrl, qrCode) {
            try {
                const response = await fetch(qrUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `QR_${qrCode}.png`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                console.error('Error al descargar:', error);
                alert('No se pudo descargar. Puedes hacer captura de pantalla del QR.');
            }
        };

        window.printAllQRs = function() {
            const monthEmps = employees.filter(e => e.registrationDate && e.registrationDate.slice(0, 7) === selectedMonth);
            
            if (monthEmps.length === 0) {
                alert('No hay colaboradores en este mes para imprimir');
                return;
            }

            // URL fija de GitHub Pages
            const baseUrl = 'https://kelbinvdp.github.io/ticketdealmuerzo';

            let printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>C√≥digos QR - ${getMonths().find(m => m.key === selectedMonth)?.name}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #2563eb;
                            padding-bottom: 15px;
                        }
                        .grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 30px;
                        }
                        .qr-card {
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            padding: 20px;
                            text-align: center;
                            page-break-inside: avoid;
                            background: white;
                        }
                        .qr-card h3 {
                            margin: 0 0 10px 0;
                            color: #1f2937;
                            font-size: 18px;
                        }
                        .qr-card .dept {
                            color: #6b7280;
                            font-size: 14px;
                            margin-bottom: 15px;
                        }
                        .qr-card img {
                            width: 200px;
                            height: 200px;
                            margin: 15px auto;
                            display: block;
                        }
                        .qr-code-text {
                            background: #f3f4f6;
                            padding: 10px;
                            border-radius: 6px;
                            font-family: monospace;
                            font-size: 14px;
                            font-weight: bold;
                            margin-top: 10px;
                            color: #1f2937;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>C√≥digos QR de Acceso</h1>
                        <p>${getMonths().find(m => m.key === selectedMonth)?.name}</p>
                        <p style="font-size: 14px; color: #6b7280;">Total: ${monthEmps.length} colaboradores</p>
                    </div>
                    <div class="grid">
            `;

            monthEmps.forEach(emp => {
                const loginUrl = `${baseUrl}?qr=${encodeURIComponent(emp.qrCode)}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(loginUrl)}`;
                printContent += `
                    <div class="qr-card">
                        <h3>${emp.name}</h3>
                        <div class="dept">${emp.department}</div>
                        <img src="${qrUrl}" alt="QR Code">
                        <div class="qr-code-text">${emp.qrCode}</div>
                    </div>
                `;
            });

            printContent += `
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Esperar a que las im√°genes carguen antes de imprimir
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
            };
        };

        // FUNCIONES DE ELIMINACI√ìN
        window.deleteEmp = async function(empId, empName) {
            if (!confirm(`¬øEliminar a ${empName}?`)) return;
            
            const empTickets = tickets.filter(t => t.employeeId === empId);
            for (const t of empTickets) {
                await deleteDoc(doc(db, 'tickets', t.id));
            }
            
            const empUsage = ticketUsage.filter(u => u.employeeId === empId);
            for (const u of empUsage) {
                await deleteDoc(doc(db, 'ticketUsage', u.id));
            }
            
            await deleteDoc(doc(db, 'employees', empId));
            alert('‚úÖ Colaborador eliminado');
        };

        window.deleteTicket = async function(ticketId, ticketCode) {
            if (!confirm(`¬øEliminar ticket ${ticketCode}?`)) return;
            
            const ticketUses = ticketUsage.filter(u => u.ticketId === ticketId);
            for (const u of ticketUses) {
                await deleteDoc(doc(db, 'ticketUsage', u.id));
            }
            
            await deleteDoc(doc(db, 'tickets', ticketId));
            alert('‚úÖ Ticket eliminado');
        };

        // FUNCIONES DE FILTRADO
        window.filterEmps = function(search) {
            const rows = document.querySelectorAll('.emp-row');
            const searchLower = search.toLowerCase().trim();
            
            rows.forEach(row => {
                const id = row.dataset.id;
                const name = row.dataset.name;
                const matches = id.includes(searchLower) || name.includes(searchLower);
                row.style.display = matches ? '' : 'none';
            });
        };

        window.filterTickets = function(search) {
            const rows = document.querySelectorAll('.ticket-row');
            const searchLower = search.toLowerCase().trim();
            
            rows.forEach(row => {
                const emp = row.dataset.emp;
                const matches = emp.includes(searchLower);
                row.style.display = matches ? '' : 'none';
            });
        };

        window.cleanDB = async function() {
            if (!confirm('‚ö†Ô∏è Eliminar TODO?')) return;
            if (!confirm('¬øREALMENTE seguro?')) return;
            
            for (const e of employees) await deleteDoc(doc(db, 'employees', e.id));
            for (const t of tickets) await deleteDoc(doc(db, 'tickets', t.id));
            for (const u of ticketUsage) await deleteDoc(doc(db, 'ticketUsage', u.id));
            
            employees = [];
            tickets = [];
            ticketUsage = [];
            alert('‚úÖ Base de datos limpiada');
            renderAdmin();
        };

        // Iniciar
        window.addEventListener('DOMContentLoaded', async () => {
            // Verificar localStorage
            storageAvailable = checkStorageAvailable();
            console.log('localStorage disponible:', storageAvailable);
            
            // Verificar si hay un c√≥digo QR en la URL antes de cargar
            const urlParams = new URLSearchParams(window.location.search);
            const qrFromUrl = urlParams.get('qr');
            
            // Verificar si hay sesi√≥n guardada
            let savedUserType = null;
            let savedUserId = null;
            let savedUserCode = null;
            let savedUserName = null;
            
            if (storageAvailable) {
                try {
                    savedUserType = localStorage.getItem('ticketSystem_userType');
                    savedUserId = localStorage.getItem('ticketSystem_userId');
                    savedUserCode = localStorage.getItem('ticketSystem_userCode');
                    savedUserName = localStorage.getItem('ticketSystem_userName');
                    console.log('Sesi√≥n guardada detectada:', { savedUserType, savedUserName });
                } catch (error) {
                    console.error('Error al leer sesi√≥n:', error);
                    storageAvailable = false;
                }
            }
            
            // Mostrar pantalla de carga
            if (qrFromUrl || savedUserType) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                            <div class="text-6xl mb-4">‚è≥</div>
                            <h2 class="text-2xl font-bold mb-2">Cargando...</h2>
                            <p class="text-gray-600">${qrFromUrl ? `Accediendo con QR...` : savedUserName ? `Bienvenido ${savedUserName}` : 'Restaurando sesi√≥n...'}</p>
                            <div class="mt-6">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Cargar datos desde Firebase
            await Promise.all([loadEmployees(), loadTickets(), loadUsage()]);
            
            console.log('Empleados cargados:', employees.length);
            
            // Prioridad 1: QR desde URL
            if (qrFromUrl) {
                console.log('Login desde URL con QR:', qrFromUrl);
                // Limpiar la URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Buscar el empleado
                const emp = employees.find(e => e.qrCode === qrFromUrl);
                
                if (emp) {
                    // Login autom√°tico exitoso
                    userType = 'employee';
                    currentUser = emp;
                    
                    // Guardar sesi√≥n
                    if (storageAvailable) {
                        try {
                            localStorage.setItem('ticketSystem_userType', 'employee');
                            localStorage.setItem('ticketSystem_userId', emp.id);
                            localStorage.setItem('ticketSystem_userCode', qrFromUrl);
                            localStorage.setItem('ticketSystem_userName', emp.name);
                            console.log('Sesi√≥n guardada desde QR URL');
                        } catch (error) {
                            console.error('No se pudo guardar la sesi√≥n:', error);
                            storageAvailable = false;
                        }
                    }
                    
                    // Guardar en historial
                    saveCodeToHistory(qrFromUrl, emp.name);
                    
                    renderEmployee();
                } else if (qrFromUrl === ADMIN_CODE) {
                    // Login como admin
                    userType = 'admin';
                    currentUser = { name: 'Administrador' };
                    
                    // Guardar sesi√≥n
                    if (storageAvailable) {
                        try {
                            localStorage.setItem('ticketSystem_userType', 'admin');
                            localStorage.setItem('ticketSystem_userCode', qrFromUrl);
                            console.log('Sesi√≥n admin guardada desde QR URL');
                        } catch (error) {
                            console.error('No se pudo guardar la sesi√≥n:', error);
                            storageAvailable = false;
                        }
                    }
                    
                    renderAdmin();
                } else {
                    // C√≥digo no v√°lido - mostrar login con el c√≥digo
                    renderLogin();
                    setTimeout(() => {
                        showQRInput(qrFromUrl, true); // Mostrar historial si es de colaborador
                        alert(`‚ö†Ô∏è C√≥digo QR no encontrado: ${qrFromUrl}\n\nVerifica que est√© registrado en el sistema.`);
                    }, 100);
                }
            } 
            // Prioridad 2: Sesi√≥n guardada
            else if (savedUserType && storageAvailable) {
                console.log('Restaurando sesi√≥n guardada:', savedUserType);
                if (savedUserType === 'admin') {
                    userType = 'admin';
                    currentUser = { name: 'Administrador' };
                    renderAdmin();
                    console.log('Sesi√≥n admin restaurada');
                } else if (savedUserType === 'employee' && savedUserId) {
                    const emp = employees.find(e => e.id === savedUserId);
                    if (emp) {
                        userType = 'employee';
                        currentUser = emp;
                        renderEmployee();
                        console.log('Sesi√≥n empleado restaurada:', emp.name);
                    } else {
                        // Usuario no encontrado, limpiar sesi√≥n
                        console.log('Usuario no encontrado, limpiando sesi√≥n');
                        if (storageAvailable) {
                            try {
                                localStorage.removeItem('ticketSystem_userType');
                                localStorage.removeItem('ticketSystem_userId');
                                localStorage.removeItem('ticketSystem_userCode');
                                localStorage.removeItem('ticketSystem_userName');
                            } catch (error) {
                                console.error('Error al limpiar sesi√≥n:', error);
                            }
                        }
                        renderLogin();
                        alert('‚ö†Ô∏è Tu sesi√≥n expir√≥. Por favor, inicia sesi√≥n nuevamente.');
                    }
                } else {
                    renderLogin();
                }
            } 
            // Sin QR ni sesi√≥n: mostrar login normal
            else {
                console.log('Sin sesi√≥n, mostrando login');
                renderLogin();
            }
        });
    </script>
</body>
</html>
